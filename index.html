<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Person Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .header {
            background-color: #4a6fa5;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            text-align: center;
            position: relative;
        }
        
        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message-time {
            font-size: 0.7rem;
            margin-top: 5px;
            opacity: 0.7;
        }
        
        .sent {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        
        .received {
            align-self: flex-start;
            background-color: #f1f0f0;
        }
        
        .input-area {
            display: flex;
            padding: 15px;
            background-color: #f0f2f5;
            border-radius: 0 0 10px 10px;
        }
        
        #message-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            outline: none;
            resize: none;
            font-size: 16px;
        }
        
        #send-button {
            background-color: #4a6fa5;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #send-button:hover {
            background-color: #3a5a80;
        }
        
        .login-container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-container h2 {
            margin-bottom: 20px;
            color: #4a6fa5;
        }
        
        .login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .login-container button {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        .login-container button:hover {
            background-color: #3a5a80;
        }
        
        .status {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online {
            background-color: #4caf50;
        }
        
        .offline {
            background-color: #f44336;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="login-screen" class="login-container">
        <h2>Enter Chat Room</h2>
        <p>Only two people can join this chat.</p>
        <input type="text" id="username-input" placeholder="Enter your name...">
        <button id="join-button">Join Chat</button>
        <p id="login-error" class="error-message"></p>
    </div>
    
    <div id="chat-screen" class="container" style="display: none;">
        <div class="header">
            <h2>Two-Person Chat</h2>
            <div class="status">
                <div id="status-indicator" class="status-indicator offline"></div>
                <span id="status-text">Waiting for another person</span>
            </div>
        </div>
        <div id="chat-area" class="chat-area"></div>
        <div class="input-area">
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGepN0JCQqPhySfxSUhsXPGoAKjgNbtHc",
            authDomain: "neo9-c8021.firebaseapp.com",
            projectId: "neo9-c8021",
            storageBucket: "neo9-c8021.firebasestorage.app",
            messagingSenderId: "1093870223636",
            appId: "1:1093870223636:web:0c6fd96045f609c02c8201",
            measurementId: "G-0RP5GMBV81",
            databaseURL: "https://neo9-c8021-default-rtdb.firebaseio.com"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize Realtime Database
        const db = firebase.database();
        
        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const usernameInput = document.getElementById('username-input');
        const joinButton = document.getElementById('join-button');
        const chatArea = document.getElementById('chat-area');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const loginError = document.getElementById('login-error');

        // Chat state
        let username = '';
        let isActive = false;
        let userId = '';
        let usersRef;
        let messagesRef;
        
        // Initialize chat
        function init() {
            // Set up references
            usersRef = db.ref('users');
            messagesRef = db.ref('messages');
            
            // Set up event listeners
            joinButton.addEventListener('click', joinChat);
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });
        }
        
        // Join the chat
        function joinChat() {
            username = usernameInput.value.trim();
            
            if (!username) {
                loginError.textContent = 'Please enter a name';
                return;
            }
            
            // First check if two users are already in the chat
            usersRef.once('value')
                .then(snapshot => {
                    const users = snapshot.val() || {};
                    const activeUsers = Object.values(users).filter(user => {
                        return user.active && Date.now() - user.lastActive < 15000;
                    });
                    
                    // Check if user already exists
                    let existingUser = null;
                    Object.keys(users).forEach(key => {
                        if (users[key].name === username) {
                            existingUser = key;
                        }
                    });
                    
                    if (activeUsers.length >= 2 && !existingUser) {
                        loginError.textContent = 'Chat room is full. Only two people can join.';
                        return Promise.reject('Chat room is full');
                    }
                    
                    // If user exists, use the same ID, otherwise create new
                    if (existingUser) {
                        userId = existingUser;
                        return usersRef.child(userId).update({
                            active: true,
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    } else {
                        // Add new user
                        const newUserRef = usersRef.push();
                        userId = newUserRef.key;
                        return newUserRef.set({
                            name: username,
                            active: true,
                            lastActive: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                })
                .then(() => {
                    // Set up presence system
                    setupPresence();
                    
                    // Switch to chat screen
                    loginScreen.style.display = 'none';
                    chatScreen.style.display = 'flex';
                    
                    // Load messages and start real-time updates
                    setupMessageListener();
                    setupUserStatusListener();
                    
                    // Focus the message input
                    messageInput.focus();
                })
                .catch(error => {
                    if (error !== 'Chat room is full') {
                        console.error('Error joining chat:', error);
                        loginError.textContent = 'Error joining chat. Please try again.';
                    }
                });
        }
        
        // Set up user presence monitoring
        function setupPresence() {
            // Create a presence reference
            const userStatusRef = usersRef.child(userId);
            
            // Update last active timestamp every 5 seconds
            setInterval(() => {
                if (isActive) {
                    userStatusRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 5000);
            
            // Set as online when window gains focus
            window.addEventListener('focus', () => {
                isActive = true;
                userStatusRef.update({
                    active: true,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            });
            
            // Set as offline when window loses focus
            window.addEventListener('blur', () => {
                isActive = false;
                userStatusRef.update({
                    active: false
                });
            });
            
            // Set as inactive when user leaves
            window.addEventListener('beforeunload', () => {
                userStatusRef.update({
                    active: false
                });
            });
            
            // Set as active now
            isActive = true;
        }
        
        // Send a message
        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;
            
            // Push new message to Firebase
            messagesRef.push({
                sender: username,
                senderId: userId,
                text: messageText,
                time: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                // Clear input
                messageInput.value = '';
                messageInput.style.height = 'auto';
            })
            .catch(error => {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            });
        }
        
        // Display a message in the chat area
        function displayMessage(message, key) {
            // Check if message is already displayed
            if (document.getElementById('msg-' + key)) return;
            
            const messageElement = document.createElement('div');
            messageElement.id = 'msg-' + key;
            messageElement.classList.add('message');
            messageElement.classList.add(message.senderId === userId ? 'sent' : 'received');
            
            const messageText = document.createElement('div');
            messageText.textContent = message.text;
            
            const messageTime = document.createElement('div');
            messageTime.classList.add('message-time');
            messageTime.textContent = formatTime(message.time);
            
            if (message.senderId !== userId) {
                const senderName = document.createElement('div');
                senderName.style.fontWeight = 'bold';
                senderName.style.marginBottom = '3px';
                senderName.textContent = message.sender;
                messageElement.appendChild(senderName);
            }
            
            messageElement.appendChild(messageText);
            messageElement.appendChild(messageTime);
            
            chatArea.appendChild(messageElement);
            scrollToBottom();
        }
        
        // Set up listener for new messages
        function setupMessageListener() {
            messagesRef.on('child_added', snapshot => {
                const message = snapshot.val();
                const key = snapshot.key;
                
                if (message) {
                    displayMessage(message, key);
                }
            });
        }
        
        // Set up listener for user status changes
        function setupUserStatusListener() {
            usersRef.on('value', snapshot => {
                const users = snapshot.val() || {};
                const activeUsers = [];
                
                // Check active users
                Object.keys(users).forEach(key => {
                    const user = users[key];
                    if (user.active && key !== userId && Date.now() - user.lastActive < 15000) {
                        activeUsers.push(user);
                    }
                });
                
                // Update UI based on active users
                updateUserStatusUI(activeUsers[0]);
            });
        }
        
        // Update user status UI
        function updateUserStatusUI(otherUser) {
            if (otherUser) {
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = `Chatting with ${otherUser.name}`;
            } else {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Waiting for another person';
            }
        }
        
        // Format timestamp to HH:MM
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Scroll chat area to the bottom
        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>
